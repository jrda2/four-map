<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <title>Neighborhood Map</title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-min.js"></script>
    
    <style>
       #map {
         height: 400px;
         width: 100%;
       }
    </style>
    </head>

<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Neighborhood Map</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right">
            <div class="dropdown">
              <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                Neighborhood
                <span class="caret"></span>
              </button>
              <ul class="dropdown-menu" data-bind="foreach: postalCodes">
               <li data-bind="text: title, click: $root.postalDrop"></li>
              </ul>
            </div>
          </form>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-3 col-md-2 sidebar">
          <ul data-bind="foreach: rest_markers" class="nav nav-sidebar">
           <span data-bind= "visible: setPostVis"> 
           <li class="res" data-bind="text: title, click: $root.bindMarker"></li>
           </span>
          </ul>
        </div>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <h1 class="page-header">Where is my sushi?</h1>
           <div id="map"> </div>

          </div>
      </div>
    </div>


<!-- Google Maps Code -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script>

function RestaurantViewModel (){
    var self = this;



    self.restaurants = ko.observableArray();
    self.list_rest = ko.observableArray();
    self.rest_markers = ko.observableArray();
    self.alt_markers = ko.observableArray();


    self.postalCodes = [
    { title: "94109"}, 
    { title: "94118"}, 
    { title: "94110"}];

    self.getContent = function() {
       $.ajax({
            url: "https://api.foursquare.com/v2/venues/search?ll=37.784469,-122.407986&query=sushi&client_id=G5TOZ3XNP4JW4UBDSZB0JZ54RLFGYPLGLHON22FTT5QUI0GR&client_secret=C1HH2ESSFEZ5XPGZDR5TRN1V3ABO0P1G53NDXK3C33GPCS3R&v=20170524",

            jsonp: "callback",

            dataType: "jsonp",

            data: {
             q: "select id,name,location.lat,location.lng, location.postalCode from response.venue",
             format: "json"
            },
       success: function (response) {

        for (var i = 0, length = response.response.venues.length; i < length; i++) {
            self.processData(response.response.venues[i]);
            
          }
            self.addMapData(self.restaurants());
        }    
    });
}

    self.createInfo = function(restaurant) {
        var string = '<div id="content">'+
                '<div id="siteNotice">'+
                '</div>'+
                '<h1 id="firstHeading" class="firstHeading">' + restaurant.title + '</h1>'+
                '<div id="bodyContent">'+
                 '<p><b>Phone</b>: ' + restaurant.phone + '</br>' +
                 '<p><b>Check Ins</b>: ' + restaurant.stats.checkins + '</br>' +
                 '<p><b>Tips</b>: ' + restaurant.stats.tips + '</br>' +
                 '<p><b>Foursquare Interactions</b>: ' + restaurant.stats.users + '</br>' +
                '</div>'+
                '</div>';
        return string;
    }

    self.processData = function(data_obj) {
        var rest_obj = {
            title: data_obj.name,
            phone: data_obj.contact.phone,
            lat: data_obj.location.lat,
            lng: data_obj.location.lng,
            postal: data_obj.location.postalCode,
            stats: {
                checkins: data_obj.stats.checkinsCount,
                tips: data_obj.stats.tipCount,
                users: data_obj.stats.usersCount
            }
        }
        self.restaurants().push(rest_obj);
    }
        
    self.addMapData = function(restaurants) {
        for (var i = 0, length = restaurants.length; i < length; i++) {
            var contentString = self.createInfo(restaurants[i]);

            var latLng = {lat: restaurants[i].lat, lng: restaurants[i].lng};
            var marker = new google.maps.Marker({
                position: latLng,
                map: self.map,
                animation: google.maps.Animation.DROP,
                title: restaurants[i].title,
                postal: restaurants[i].postal,
                setPostVis: ko.observable(true)
                });

            self.rest_markers.push(marker);
            var infoWindow = new google.maps.InfoWindow({
                content: contentString
            });
            self.bindInfoWindow(marker, self.map, infoWindow, contentString);
            self.list_rest.push(restaurants[i]);
        }
    }

    self.bindMarker = function (marker) {
        google.maps.event.trigger(marker, 'click');
        }    

    self.bindInfoWindow = function(marker, map, infowindow, contentString){
        marker.addListener('click', function() {
            infowindow.setContent(contentString);
            infowindow.open(map, this);

        if (marker.getAnimation() !== null) {
              marker.setAnimation(null);
            } else {
              marker.setAnimation(google.maps.Animation.BOUNCE);
            }   
        });
    }

    self.postalDrop = function (postal) {
        for (var i = 0, length = self.rest_markers().length; i < length; i++) {
            if (self.rest_markers()[i].postal == postal.title) {
                console.log("matched");
            } else {
                self.rest_markers()[i].setPostVis = ko.observable(false);
            }   
        }
    }

    self.clearPostalDrop = function() {
        for (var i = 0, length = self.rest_markers().length; i < length; i++) {
            self.rest_markers()[i].setPostVis = ko.observable(true);
    }
}

    self.initMap = function(){
        self.map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: 37.784469, lng: -122.407986},
        zoom: 13
      });
        self.getContent();       
    }
}

var myRestModel = new RestaurantViewModel();
ko.applyBindings(myRestModel);


function initMap() {
    myRestModel.initMap();
}

function gError() {
    windows.alert("Maps is currently not available");
    }


</script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkYowSd7WqlQNvH4Fqy_TZDFb7IFainKY&callback=initMap" async></script>

</body>
</html>